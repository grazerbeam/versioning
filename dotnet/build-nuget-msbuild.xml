<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="4.0" DefaultTargets="default">
  <PropertyGroup>
    <BaseDir>$(MSBuildProjectDirectory)</BaseDir>
    <Configuration Condition="'$(Configuration)'==''" >Release</Configuration>
    <BuildDir>$(BaseDir)\build</BuildDir>
    <SolutionFile>$(BaseDir)\Puzzlebox.Versioning.sln</SolutionFile>
    <MSBuildExtensions>$(BaseDir)\lib\msbuild\msbuild.community.tasks.dll</MSBuildExtensions>
    <PackageDir>$(BuildDir)\Packages</PackageDir>
    <PackageSuffix Condition="'$(PackageSuffix)'!=''"></PackageSuffix>
    <OutputDir>$(BuildDir)\$(Configuration)$(PackageSuffix)</OutputDir>
  </PropertyGroup>

  <UsingTask AssemblyFile="$(MSBuildExtensions)" TaskName="MSBuild.Community.Tasks.Zip" />
  <UsingTask AssemblyFile="$(MSBuildExtensions)" TaskName="MSBuild.Community.Tasks.XmlUpdate" />
    
  <Target Name="default" DependsOnTargets="Compile; Deploy; PackageZip; CreatePackages" />
  
  <Target Name="Compile">
    <MSBuild Projects="$(SolutionFile)" Properties="Configuration=$(Configuration)"  Targets="Rebuild" />
    <MSBuild Projects="$(SolutionFile)" Properties="Configuration=$(Configuration);PerformSigning=True" Targets="Rebuild" />
  </Target>

  <Target Name="Deploy">
    <ItemGroup>
      <MainBinaries Include="$(BaseDir)\Puzzlebox.Versioning.Business\bin\$(Configuration)\**\*.*" />
    </ItemGroup>

    <!-- Copy to the output directory -->
    <Copy SourceFiles="@(MainBinaries)" DestinationFolder="$(OutputDir)\%(RecursiveDir)"  />

    <!--<Copy SourceFiles="@(WP7Binaries)" DestinationFolder="$(OutputDir)\WP7\%(RecursiveDir)"  Condition="'$(BuildSilverlight)' == 'true'"/>-->
    <Copy SourceFiles="@(Docs)" DestinationFolder="$(OutputDir)" />
  </Target>

  <Target Name="PackageZip">
    <ItemGroup>
      <FilesToZip Include="$(OutputDir)\**\*.*" />
    </ItemGroup>
    <Message Text="@(FilesToZip)" />
    <Zip Files="@(FilesToZip)" ZipFileName="$(BuildDir)\Puzzlebox.Versioning$(PackageSuffix).zip" WorkingDirectory="$(OutputDir)" />
  </Target>


  <Target Name="CreatePackages" DependsOnTargets="Deploy">
    <!-- First copy the nuspec template files to the package dir -->
    <Copy SourceFiles="$(MSBuildProjectDirectory)\Puzzlebox.Versioning$(PackageSuffix).nuspec" DestinationFolder="$(PackageDir)\temp\Puzzlebox.Versioning$(PackageSuffix)" />

    <!-- Copy the source files to the package dir -->
    <Copy SourceFiles="@(MainBinaries)" DestinationFolder="$(PackageDir)\temp\Puzzlebox.Versioning$(PackageSuffix)\lib\Net40\%(RecursiveDir)" />
    
    <!-- Get the version number of the main FV assembly to insert into the nuspec files -->
    <Message Text="$(OutputDir)" />
    <GetAssemblyIdentity AssemblyFiles="$(OutputDir)\Puzzlebox.Versioning.Business.dll">
      <Output TaskParameter="Assemblies" ItemName="AsmInfo" />
    </GetAssemblyIdentity>

    <!-- insert the version number into the nuspec files -->
    <XmlUpdate
      Namespace="http://schemas.microsoft.com/packaging/2010/07/nuspec.xsd"
      XmlFileName="$(PackageDir)\temp\Puzzlebox.Versioning$(PackageSuffix)\Puzzlebox.Versioning$(PackageSuffix).nuspec"
      XPath="/package/metadata/version"
      Value="%(AsmInfo.Version)" />

    <Exec WorkingDirectory="$(BuildDir)\Packages" 
          Command="$(BaseDir)\.nuget\nuget.exe pack $(PackageDir)\temp\Puzzlebox.Versioning$(PackageSuffix)\Puzzlebox.Versioning$(PackageSuffix).nuspec" />

    <RemoveDir Directories="$(PackageDir)\temp" />
  </Target>  
  
</Project>